# Here we will build Node.js only, so keep it simple
language: node_js

cache:
  # Cache Node.js's './node_modules' folder
  npm: true
  directories:
  # Cache SonarQube's folder
  - '$HOME/.sonar/cache'

env:
  global:
  # Standard container name (schema: project/application). Used to build the image and push it to the repo
  - CONTAINER_NAME='enterpriseflowsrepository/dashboard'
  # Short container tag. Contains major, monor & patch values
  # Example: 1.7.2
  - CONTAINER_TAG_SHORT=`node -p "require('./package.json').version"`
  # Long container tag. Used to select an unique build version. Allow to quickly know the build date plus the referenced git commit
  # Example: 1.7.2-20191113211021-921103d
  - CONTAINER_TAG_FULL="$CONTAINER_TAG_SHORT-$(date +'%Y%m%d%H%M%S')-$(git rev-parse --short HEAD)"
  # CONTAINER_REPO_HUB_DOCKER_COM_USERNAME
  - secure: xBcdiUj/3LAU/F01g8VfXwfihM8wr2bEMRwHIosmv0lxQNtm8guJUP3ivDowL2jQVG1LVMane/+UYjYb/jlrRHFQHoCMPMkXCu7HySknmGe4aE+aPCWhbIs517H21C5urhEdVZDkr0pYTzu8E//Zl5pBRFFaeVUiNeOGfmnRZibDOJVyfR1TEJUM5VdlfB3sQManxDSChsAkORh1Ty85wpgsskawkH5cbejYUB9KmiFcetNtl+BbLEx6TFOYX7T8pnI52ojQYGzpNUbQYCLzMy/RbMswybKuHN8vkUxEUbBHd1SPaTruvhYyiZJlVGnYc3khSUW/+S4pnI7apOowernT58xoTXjB7Uxwr9K09261/pGGCE/2Uu8Lut7HAVcWnDtx9EVL8tSx55ia9gCsIeoLxWXnuWIlXEbpAM/0hqEupBVvAF53+dhN101vGFoCgU8Ay0pqE7kv5R80gdS7VidAg+Dhpzt1+78Q/ibQ5IG5kXx6emKLkFuoshJG3ikJw2Yls9ldsfhrCvtI3v/mpQZCFO4iCZnmvicDiwRGA2br6ogSuYV7zH9YyWJEC5/zGbbfv7WKTtFM1ZccDSQRzmKM78saF3zNQ4mbaD7col58sI1W50LH/+/pIaem15FDRPWstULazROlzOqEIxdNeID3a+/RlK+dPyBOmXMnWHI=
  # CONTAINER_REPO_HUB_DOCKER_COM_PASSWORD
  - secure: SnUH/clnwfeB9Z4W4Ar8OiGOcv6hd5jWVhHAv1mKc2PZZZ0u+OgANWXuGSyGat503I9RjtajVTDOStbMZE38CRAZT+MXTathXo/LwRJ7iPYkfG2SZkO8/4MYQbvuh27G3im7kT3vSHK+9qleAP65CuaRhRQrdJTy5aG0SKXVrsd5q9i7mMro7w5fNxmiTdYASQTzTECWoRQaWI/39HNPDiZo0m/furka5lu3kt8N40ag4W7dA7n1zPfby5ZTdJ1HSo8QKVe3xMbWrU5T77LOQeaUAbUfy875X8DXGYfy6IdfO8J+BJBUzPofUX/qy3IPqQdHOLiIqNTjuBsJ21v/7m5o1iAVB5A5s7hlsPj1o3HPIqTeWnox+aW/DhX+id5EdnRTko9+TtXoaikg6xd21kQFJsvjvyPk1VA9n1UyHKHZuNkxycNeRYgHb11s01SbeUy6HA1jYX+GeOGnjZk4gn8ketjBcvdbi5j/yecDWeYNRZIwA6rX0IqIzQJipZfCsIFBuw5rouQNZVQmNgqMoad68puNoxzbMKz9clqWp+n/HjspQs3TQx5YqSkCSlt/pQ6WFx6lPQTgxkgf5Lw9Mx1bqoej2bdDpK6dYj8RUgtwOVEF79TzSPksGXunnt63/IEwk7nI92QzbJgYF0PrAAVzvPHC6e4Fkil0J5Zery0=
  # FOSSA_API_KEY
  - secure: vp+bWf9kYkpfsu28MHk24Oy7RSvgB4DoQ71dk2dgv0AyH9H4t3eIsO2kj34N077cCtWzTDCViB2eL3yvScrou75wTcgST7K//FQUVrZk+KiDt4Y8u7g6LUZOJPT7VZFqhGKSvsSsTdsZMGwKHj3qeOK3+on6xcJpLalXaOqaun+Q/e1hiUUzWDPeGEqhR7p7fIpWK2wrJ1IQoYw0Br1A7EN5/jCFBaUHEkz1ay1m25iK78R8voYQuBxa/vYaJoGHOzyMnOHT9kdM4yvjDejFOtosh/TdfR1NWQrLrB7XY9gxwVSRVgHZEZv0HYmhnVsppocYO15D4i4gH5YZMG3sY3IR/ckODMBnH3WBtGGxakI2ZhXmGqqUzQio6jyOkJW/OpSPe6lJo9wsO5BNaZ8u13LUveEsqyrSZT/XglX7rcyZqSMdtkmRJxQn9dpFNjm6vxDzMuttzPeWTukDP3GK85YZ5U0SE53ssBz2yOV2vGJDxDDn1FPW30FIuOgIeSiaBNDnjgsuSL6PftPjfVcQ/on0baqXb9//NgQ+a0FM14I1NkaWrk0JkjOqppnsPhB7keeNVNeMilRWRllroTt3bRISat5Kev5UsiamCzq1SLp3AtiNAHBBzZKnwDSEaWzHthHNIrhhTFi/vteDTWDzytnlBB+trbD7TyWn30CmvME=

services:
# Display service needed for Chromium and the React.js test suite
- xvfb
# We will create containers here!
- docker

addons:
  # Chromium is used to perform integration tests with React.js
  chrome: stable
  # Post build tests, quality and CVE detection by SonarQube
  sonarcloud:
    organization: enterpriseflowsrepository
    token:
      secure: elDsLWuzhpsyWm2IJs2fmg4OU8+HdRS7dDoX1PtBTwk/W1RV/u8l8Jw9hZMlLZqQ9/45JxJZjKSdGLyOx6L45rh+E5YsgfBnqGHeODXcDcIQZzkzYWo9mP8ehmDw7VI7A6T7GptE9JlNUJkb+r/CxVbD+I3CHkLbruBePVA1xlBtVWNA+I9vY2Z2bfrHbyOs52Hn6A87npcDBOkIFGiTek07jxfcOMWsyyRaaz/w6dPr1MuT/2KqXUhal6KrsykK0knryVR5q1hmP/fT6knBINAG6hhWej24pa7V9u7uHDCt19Pmf3amG+HJOfPnLcIIK5MXu6hYV0QmIvSZQacfQMw8GPpAVOoBqALtdf9/adEAK6FTk1JlB0FTxuESgDoNS+fLTrHBOxJ3RjrJzfIzaA/03YCcuerTRcAkTvRVB+MRhy/xmFfaLbExr512ZfwKJmsIEFzOUEfhYyCO7J9QadpzIL7AmquLiRKsowgY26DrjR3YKoWgZa0uOb0vrydhGRt6BThMcWTxzPe73iLSjcXYxpD3l6o6/ShnZkfWjeIMHpeJMp/SsG9Hw/4gqp12vFIfLXkC/gDaVXaBkGFDO/CUW2DgSi9ws9qOmp6+IgdKxYIu3moQKkf1ub/PBpH+0BC41o+KGTduT55cmT1DnNRSySOgfeYctRqIYekBMn0=
  apt:
    packages:
    # Force usage of the latest Docker version
    # See: https://docs.travis-ci.com/user/docker/#installing-a-newer-docker-version
    - docker-ce

before_install:
# Fix the Node.js browser integration test with a non-desktop environnement
- export CHROME_BIN=chromium-browser
- export DISPLAY=:99.0
# Install Fossa
- curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install.sh | bash

script:
# Launch test jobs
- npm test -- --maxWorkers=4
# Hardcode the build versions to the app
- printf "VERSION_SHORT=${CONTAINER_TAG_SHORT}\nVERSION=${CONTAINER_TAG_FULL}" > .env
# Build the Node.js binaries
- npm run build
# Build the container
- docker build --file deployment/docker/Dockerfile -t "$CONTAINER_NAME" .
# Run Fossa analysis
# See: https://docs.fossa.com/docs/travisci
- fossa analyze

after_success:
# Launch SonarQube implementation then send the report to SonarCloud cloud platform
- sonar-scanner
# Make this build fail if the licence analysis returned a negative result
# See: https://docs.fossa.com/docs/travisci
- fossa test

notifications:
  # Notify each build on Slack
  slack: enterpriseflowsrepo:I2PkD1iUs0lMR3Zon4ciy5zS

deploy:
# Push builds with default tags to 'docker.io'
- provider: script
  script: bash deployment/docker/container-push.sh -r docker.io -u "$CONTAINER_REPO_HUB_DOCKER_COM_USERNAME" -p "$CONTAINER_REPO_HUB_DOCKER_COM_PASSWORD" -i "$CONTAINER_NAME" -v "$CONTAINER_TAG_SHORT" -w "$CONTAINER_TAG_FULL" -a default
  on:
    all_branches: true
# Push builds with stable tags to 'docker.io'
- provider: script
  script: bash deployment/docker/container-push.sh -r docker.io -u "$CONTAINER_REPO_HUB_DOCKER_COM_USERNAME" -p "$CONTAINER_REPO_HUB_DOCKER_COM_PASSWORD" -i "$CONTAINER_NAME" -v "$CONTAINER_TAG_SHORT" -w "$CONTAINER_TAG_FULL" -a stable
  on:
    branch: master
